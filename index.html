<!DOCTYPE html>
<html ng-app="flat">
	<head>
		<title>Cost My Flat</title>
		<meta charset="utf-8" />
		<meta name="description" content="A website providing an easy to work out the rental costs for each flatmate." />
		<meta name="keywords" content="flat,rental,cost,charge,divide,calculate,calculator,drag,drop,per room,flatmate,pay,payment,html5">
		<meta name="author" content="Matthew Harward">

		<link rel='stylesheet' href='css/reset.css' type='text/css'/>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
		<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
		<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
		<script src="js/randomColor.js"></script>
		<script src="js/app.js"></script>


		<link rel='stylesheet' href='css/base.css' type='text/css'/>

		<script>
			$(function() {
				var autocompleteCosts = [];
				for(var i = 0; i < 25; i++) {
					autocompleteCosts.push("$" + i * 100)
				}
				$("#cost-selector").autocomplete({
					source: autocompleteCosts
				});
				var sortableIn;
				$("#flat-container").sortable({
					grid: [40, 40],
					receive: function(e, ui) { sortableIn = 1; },
					over: function(e, ui) { sortableIn = 1; },
					out: function(e, ui) { sortableIn = 0; },
					beforeStop: function(e, ui) {
						if (sortableIn == 0) {
							var room_id = ui.item.attr('id');
							angular.element(ui.item).scope().removeRoomFromFlat(room_id);
							ui.item.remove();
						}
					}
				});
				$("#flat-container").disableSelection();
				$("#flat-container").droppable({
					accept: ".room",
					drop: function(event, ui) {
						var existing_room = ui.draggable;
						if (!existing_room.hasClass("flat_room")) {
							var room = $(existing_room).clone();
							room.resizable({
								connectWith: "#flat-container",
								grid: [30, 30],
								resize: function(event, ui) {
									var width = ui.element.width()/30
									var height = ui.element.height()/30
									room.find(".size").html(width + "x" + height);
									var room_id = $(this).attr('id');
									angular.element(room).scope().setRoomSize(room_id, width, height);
								}
							});
							room.droppable({
								accept: ".flatmate_img",
								drop: function(event, ui) {
									var existing_flatmate = ui.draggable;
									if (!existing_flatmate.hasClass("room_member")) {
										var flatmate = $(existing_flatmate).clone();
										flatmate.addClass("room_member");
										$(this).find('.members').append(flatmate);
										var id = flatmate.attr('id');
										var room_id = $(this).attr('id');
										angular.element(flatmate).scope().addFlatmateToRoom(room_id, id);
									}
								}
							});
							var sortableIn2;
							room.find(".members").sortable({
								receive: function(e, ui) { sortableIn2 = 1; },
								over: function(e, ui) { sortableIn2 = 1; },
								out: function(e, ui) { sortableIn2 = 0; },
								beforeStop: function(e, ui) {
									if (sortableIn2 == 0) {
										var id = ui.item.attr('id');
										var room_id = $(this).attr('id');
										angular.element(this).scope().removeFlatmateFromRoom(room_id, id);
										ui.item.remove();
									} 
								}
							});
							room.addClass("flat_room");
							room.find(".size").html("3x3");
							$(this).append(room);
							var room_model = angular.element(existing_room).scope().room;
							var model = angular.element(room).scope().addRoomToFlat(room_model);
							room.attr('id', model.id);
						}
					}
				});
			});
		</script>
	</head>
	<body>
		<div class="container" ng-controller="FlatController">
			<h1>Cost My Flat</h1>
			<div id="settings" class="section">
				<p>Ever had to work out how my each flatmate should pay for rent? Need a transparent system that is just plain fair? Look no further! Model your flat below and we'll tell you how much each flatmate should pay and why.</p>
				<div class="control">Rent costs
					<input id="cost-selector" class="input" value="${{rent}}" required ng-minlength="1" ng-maxlength="5"></input>
					per
					<select id="freq-selector" class="input" ng-init="rentalPeriod = periods[1]" ng-model="rentalPeriod" ng-options="period.name for period in periods"></select>
				</div>
			</div>
			<div id="flat" class="section">
				<h2>Flat</h2>
				<div id="flat-container">

				</div>
			</div>
			<div id="palette" class="section">
				<h2>Palette</h2>
				<p>Drag and drop rooms onto your flat, and flatmates onto the rooms they will use</p>
				<h2>Rooms</h2>
				<div id="rooms">
					<div class="room" ng-repeat="room in roomPalette" style="background-color: {{room.color}};" room-drag><span>{{room.name}}</span><span class="size"></span><div class="members"></div></div>
				</div>
				<h2>Flatmates</h2>
				<button ng-click="addFlatmateToPalette()" ng-disabled="flatmatePalette.length >= 15">+</button>
				<div id="flatmates">
					<div class="flatmate" ng-repeat="flatmate in flatmatePalette" flatmate-drag>
						<div id="{{flatmate.id}}" class="flatmate_img" style="background-color: {{flatmate.color}};"></div>
						<input class="flatmate_name" value="{{flatmate.name}}"></input>
						<button ng-click="removeFlatmateFromPalette($index)">-</button>
					</div>
				</div>
			</div>
			<div id="results" class="section">
				<h2>Costing</h2>
				<div id="costing">
					<div><span>Total flat area: </span><span ng-bind="results.totalFlatArea"></span><span> m&#178;</span></div>
					<div><span>Flatmates: </span><span ng-bind="results.flatmateSummary"></span></div>
					<h3>Summary per flatmate</h3>
					<div>
						<div ng-repeat="flatmateAmount in flatmateAmounts">
							<div class="flatmate_img" style="background-color: {{flatmateAmount.color}};"></div>
							<span>{{flatmateAmount.name}}</span>
							<span>${{flatmateAmount.amount}}</span>
						</div>
					</div>
					<div><span>Total: </span>$<span ng-bind="rent"></span> per <span ng-bind="rentalPeriod.name"></span>
				</div>
			</div>
		</div>
		<footer>
			<div class="container side_by_side">
				<div class="footer_section">
					<img class="icon" src="./images/forged-icon.png" />Created by <a href="http://forgedsoftware.com">Forged Software</a>
				</div>
				<div class="footer_section">
					<img class="icon" src="./images/github-icon.png" />Hosted on <a href="https://github.com/forgedsoftware/costmyflat">GitHub</a>
				</div>
			</div>
		</footer>
	</body>
</html>
